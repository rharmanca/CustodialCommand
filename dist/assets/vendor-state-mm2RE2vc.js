const t={},e=(t,e)=>t.unstable_is?t.unstable_is(e):e===t,n=t=>"init"in t,r=t=>!!t.write,o=t=>"v"in t||"e"in t,i=e=>{if("e"in e)throw e.e;if("production"!==(t?"production":void 0)&&!("v"in e))throw new Error("[Bug] atom state is not initialized");return e.v},l=Symbol(),a=t=>t[l],d=t=>{var e;return s(t)&&!(null==(e=a(t))?void 0:e[1])},s=t=>"function"==typeof(null==t?void 0:t.then),u=(t,e,n)=>{n.p.has(t)||(n.p.add(t),e.then((()=>{n.p.delete(t)}),(()=>{n.p.delete(t)})))},c=(e,n,r)=>{const o=r(e),i="v"in o,c=o.v,f=d(o.v)?o.v:null;if(s(n)){(t=>{if(a(t))return;const e=[new Set,!1];t[l]=e;const n=()=>{e[1]=!0};t.then(n,n),t.onCancel=t=>{e[0].add(t)}})(n);for(const t of o.d.keys())u(e,n,r(t))}o.v=n,delete o.e,i&&Object.is(c,o.v)||(++o.n,f&&((e,n)=>{const r=a(e);if(r)r[1]=!0,r[0].forEach((t=>t(n)));else if("production"!==(t?"production":void 0))throw new Error("[Bug] cancelable promise not found")})(f,n))},f=(t,e,n)=>{var r;const o=new Set;for(const i of(null==(r=n.get(t))?void 0:r.t)||[])n.has(i)&&o.add(i);for(const i of e.p)o.add(i);return o},v=()=>{const t={},e=new WeakMap,n=n=>{var r,o;null==(r=e.get(t))||r.forEach((t=>t(n))),null==(o=e.get(n))||o.forEach((t=>t()))};return n.add=(n,r)=>{const o=n||t,i=(e.has(o)?e:e.set(o,new Set)).get(o);return i.add(r),()=>{null==i||i.delete(r),i.size||e.delete(o)}},n},w=Symbol(),h=(l=new WeakMap,a=new WeakMap,v=new WeakMap,h=new Set,p=new Set,g=new Set,y={},m=(t,...e)=>t.read(...e),b=(t,...e)=>t.write(...e),S=(t,e)=>{var n;return null==(n=t.unstable_onInit)?void 0:n.call(t,e)},_=(t,e)=>{var n;return null==(n=t.onMount)?void 0:n.call(t,e)},...E)=>{const k=E[0]||(e=>{if("production"!==(t?"production":void 0)&&!e)throw new Error("Atom is undefined or null");let n=l.get(e);return n||(n={d:new Map,p:new Set,n:0},l.set(e,n),null==S||S(e,R)),n}),I=E[1]||(()=>{let t,e;const n=n=>{try{n()}catch(r){t||(t=!0,e=r)}};do{y.f&&n(y.f);const t=new Set,e=t.add.bind(t);h.forEach((t=>{var n;return null==(n=a.get(t))?void 0:n.l.forEach(e)})),h.clear(),g.forEach(e),g.clear(),p.forEach(e),p.clear(),t.forEach(n),h.size&&T()}while(h.size||g.size||p.size);if(t)throw e}),T=E[2]||(()=>{const e=[],n=new WeakSet,r=new WeakSet,o=Array.from(h);for(;o.length;){const i=o[o.length-1],l=k(i);if(r.has(i))o.pop();else if(n.has(i)){if(v.get(i)===l.n)e.push([i,l]);else if("production"!==(t?"production":void 0)&&v.has(i))throw new Error("[Bug] invalidated atom exists");r.add(i),o.pop()}else{n.add(i);for(const t of f(i,l,a))n.has(t)||o.push(t)}}for(let t=e.length-1;t>=0;--t){const[n,r]=e[t];let o=!1;for(const t of r.d.keys())if(t!==n&&h.has(t)){o=!0;break}o&&(A(n),L(n)),v.delete(n)}}),A=E[3]||(l=>{var f,w;const p=k(l);if(o(p)){if(a.has(l)&&v.get(l)!==p.n)return p;if(Array.from(p.d).every((([t,e])=>A(t).n===e)))return p}p.d.clear();let g=!0;const b=()=>{a.has(l)&&(L(l),T(),I())},S=t=>{var r;if(e(l,t)){const e=k(t);if(!o(e)){if(!n(t))throw new Error("no atom init");c(t,t.init,k)}return i(e)}const s=A(t);try{return i(s)}finally{p.d.set(t,s.n),d(p.v)&&u(l,p.v,s),null==(r=a.get(t))||r.t.add(l),g||b()}};let _,E;const O={get signal(){return _||(_=new AbortController),_.signal},get setSelf(){return"production"!==(t?"production":void 0)&&r(l),!E&&r(l)&&(E=(...t)=>{if(!g)try{return M(l,...t)}finally{T(),I()}}),E}},W=p.n;try{const t=m(l,S,O);return c(l,t,k),s(t)&&(null==(f=t.onCancel)||f.call(t,(()=>null==_?void 0:_.abort())),t.then(b,b)),p}catch(z){return delete p.v,p.e=z,++p.n,p}finally{g=!1,W!==p.n&&v.get(l)===W&&(v.set(l,p.n),h.add(l),null==(w=y.c)||w.call(y,l))}}),O=E[4]||(t=>{const e=[t];for(;e.length;){const t=e.pop(),n=k(t);for(const r of f(t,n,a)){const t=k(r);v.set(r,t.n),e.push(r)}}}),M=E[5]||((t,...r)=>{let o=!0;const l=t=>i(A(t)),a=(r,...i)=>{var l;const a=k(r);try{if(e(t,r)){if(!n(r))throw new Error("atom not writable");const t=a.n,e=i[0];return c(r,e,k),L(r),void(t!==a.n&&(h.add(r),null==(l=y.c)||l.call(y,r),O(r)))}return M(r,...i)}finally{o||(T(),I())}};try{return b(t,l,a,...r)}finally{o=!1}}),L=E[6]||(t=>{var e;const n=k(t),r=a.get(t);if(r&&!d(n.v)){for(const[o,i]of n.d)if(!r.d.has(o)){const n=k(o);W(o).t.add(t),r.d.add(o),i!==n.n&&(h.add(o),null==(e=y.c)||e.call(y,o),O(o))}for(const e of r.d||[])if(!n.d.has(e)){r.d.delete(e);const n=z(e);null==n||n.t.delete(t)}}}),W=E[7]||(t=>{var e;const n=k(t);let o=a.get(t);if(!o){A(t);for(const e of n.d.keys()){W(e).t.add(t)}if(o={l:new Set,d:new Set(n.d.keys()),t:new Set},a.set(t,o),null==(e=y.m)||e.call(y,t),r(t)){const e=()=>{let e=!0;const n=(...n)=>{try{return M(t,...n)}finally{e||(T(),I())}};try{const r=_(t,n);r&&(o.u=()=>{e=!0;try{r()}finally{e=!1}})}finally{e=!1}};p.add(e)}}return o}),z=E[8]||(t=>{var e;const n=k(t);let r=a.get(t);if(!r||r.l.size||Array.from(r.t).some((e=>{var n;return null==(n=a.get(e))?void 0:n.d.has(t)})))return r;r.u&&g.add(r.u),r=void 0,a.delete(t),null==(e=y.u)||e.call(y,t);for(const o of n.d.keys()){const e=z(o);null==e||e.t.delete(t)}}),J=[l,a,v,h,p,g,y,m,b,S,_,k,I,T,A,O,M,L,W,z],R={get:t=>i(A(t)),set:(t,...e)=>{try{return M(t,...e)}finally{T(),I()}},sub:(t,e)=>{const n=W(t).l;return n.add(e),I(),()=>{n.delete(e),z(t),I()}}};return Object.defineProperty(R,w,{value:J}),R},p=t=>(t.c||(t.c=v()),t.m||(t.m=v()),t.u||(t.u=v()),t.f||(t.f=(()=>{const t=new Set,e=()=>{t.forEach((t=>t()))};return e.add=e=>(t.add(e),()=>{t.delete(e)}),e})()),t),g={};let y=0;function m(t,e){const n="atom"+ ++y,r={toString(){return"production"!==(g?"production":void 0)&&this.debugLabel?n+":"+this.debugLabel:n}};return"function"==typeof t?r.read=t:(r.init=t,r.read=b,r.write=S),e&&(r.write=e),r}function b(t){return t(this)}function S(t,e,n){return e(this,"function"==typeof n?n(t(this)):n)}const _=()=>{if("production"!==(g?"production":void 0))return(()=>{let t=0;const e=p({}),n=new WeakMap,r=new WeakMap,o=h(n,r,void 0,void 0,void 0,void 0,e,void 0,((e,n,r,...o)=>t?r(e,...o):e.write(n,r,...o))),i=new Set;e.m.add(void 0,(t=>{i.add(t),n.get(t).m=r.get(t)})),e.u.add(void 0,(t=>{i.delete(t),delete n.get(t).m}));const l={dev4_get_internal_weak_map:()=>n,dev4_get_mounted_atoms:()=>i,dev4_restore_atoms:e=>{const n={read:()=>null,write:(n,r)=>{++t;try{for(const[t,n]of e)"init"in t&&r(t,n)}finally{--t}}};o.set(n)}};return Object.assign(o,l)})();return h()};let E;const k=()=>(E||(E=_(),"production"!==(g?"production":void 0)&&(globalThis.__JOTAI_DEFAULT_STORE__||(globalThis.__JOTAI_DEFAULT_STORE__=E),globalThis.__JOTAI_DEFAULT_STORE__)),E),I={},T=Symbol("production"!==(I?"production":void 0)?"RESET":"");const A=function(t=()=>{try{return window.localStorage}catch(t){return}},e){var n;let r,o;const i={getItem:(n,i)=>{var l,a;const d=t=>{if(r!==(t=t||"")){try{o=JSON.parse(t,null==e?void 0:e.reviver)}catch(n){return i}r=t}return o},s=null!=(a=null==(l=t())?void 0:l.getItem(n))?a:null;return"function"==typeof(null==(u=s)?void 0:u.then)?s.then(d):d(s);var u},setItem:(e,n)=>{var r;return null==(r=t())?void 0:r.setItem(e,JSON.stringify(n,void 0))},removeItem:e=>{var n;return null==(n=t())?void 0:n.removeItem(e)}};let l;try{l=null==(n=t())?void 0:n.subscribe}catch(d){}var a;return!l&&"undefined"!=typeof window&&"function"==typeof window.addEventListener&&window.Storage&&(l=(e,n)=>{if(!(t()instanceof window.Storage))return()=>{};const r=r=>{r.storageArea===t()&&r.key===e&&n(r.newValue)};return window.addEventListener("storage",r),()=>{window.removeEventListener("storage",r)}}),l&&(i.subscribe=(a=l,(t,e,n)=>a(t,(t=>{let r;try{r=JSON.parse(t||"")}catch(d){r=n}e(r)})))),i}();function O(t,e,n=A,r){const o=m(e);"production"!==(I?"production":void 0)&&(o.debugPrivate=!0),o.onMount=r=>{let o;return r(n.getItem(t,e)),n.subscribe&&(o=n.subscribe(t,r,e)),o};return m((t=>t(o)),((r,i,l)=>{const a="function"==typeof l?l(r(o)):l;return a===T?(i(o,e),n.removeItem(t)):a instanceof Promise?a.then((e=>(i(o,e),n.setItem(t,e)))):(i(o,a),n.setItem(t,a))}))}export{m as a,O as b,_ as c,k as g};
