var w=(u,n,t)=>new Promise((j,m)=>{var g=r=>{try{i(t.next(r))}catch(o){m(o)}},y=r=>{try{i(t.throw(r))}catch(o){m(o)}},i=r=>r.done?j(r.value):Promise.resolve(r.value).then(g,y);i((t=t.apply(u,n)).next())});import{r as l,j as e,F as V,G as K}from"./vendor-yOkX1T9n-v6.js";import{a as Q,B as U,T as X,g as Z,h as O,i as B,I as _,S as F,p as N,q as k,r as A,s as c,bi as ee,bj as se,bk as ae}from"./index-DdeSxun1-v6.js";import"./ui-BA32w1ww-v6.js";import"./utils-Cj9wHvoQ-v6.js";import"./forms-BJ8Awwap-v6.js";import"./charts-core-ghokHKd6-v6.js";import"./pdf-export-JyY94Pcb-v6.js";const te=["ASA","LCA","GWC","OA","CBR","WLC"],le=["January","February","March","April","May","June","July","August","September","October","November","December"];function xe({onBack:u}){const{toast:n}=Q(),[t,j]=l.useState([]),[m,g]=l.useState(!0),[y,i]=l.useState(null),[r,o]=l.useState(!1),[Y,P]=l.useState(!1),[x,C]=l.useState(""),[f,L]=l.useState("all"),[p,T]=l.useState("all"),[b,M]=l.useState("all");l.useEffect(()=>{v(),R()},[]);const R=()=>{const s=localStorage.getItem("admin-session-token");P(!!s)},v=()=>w(null,null,function*(){try{const s=yield fetch("/api/monthly-feedback");if(s.ok){const a=yield s.json();Array.isArray(a)?j(a):(console.error("Invalid data format from API"),n({variant:"destructive",title:"Data Error",description:"Received invalid data format from server."}))}else throw new Error("Failed to fetch feedback")}catch(s){console.error("Error fetching feedback:",s),n({variant:"destructive",title:"Failed to Load",description:"Unable to load monthly feedback. Please try again."})}finally{g(!1)}}),S=l.useMemo(()=>Array.isArray(t)?t.filter(s=>{var a,d,E,D,I;if(!s||typeof s!="object"||f!=="all"&&s.school!==f||p!=="all"&&s.year!==parseInt(p)||b!=="all"&&s.month!==b)return!1;if(x){const h=x.toLowerCase();if(!(((a=s.school)==null?void 0:a.toLowerCase().includes(h))||((d=s.month)==null?void 0:d.toLowerCase().includes(h))||((E=s.year)==null?void 0:E.toString().includes(h))||((D=s.extractedText)==null?void 0:D.toLowerCase().includes(h))||((I=s.notes)==null?void 0:I.toLowerCase().includes(h))))return!1}return!0}):[],[t,f,p,b,x]),$=()=>{C(""),L("all"),T("all"),M("all")},J=s=>s,z=l.useMemo(()=>{if(!Array.isArray(t))return[];const s=t.map(a=>a.year).filter(a=>typeof a=="number").sort((a,d)=>d-a);return Array.from(new Set(s))},[t]),G=s=>{i(s),o(!0)},W=s=>{const a=document.createElement("a");a.href=s.pdfUrl,a.download=s.pdfFileName||`feedback-${s.month}-${s.year}.pdf`,document.body.appendChild(a),a.click(),document.body.removeChild(a)},q=s=>w(null,null,function*(){try{const a=localStorage.getItem("admin-session-token");if((yield fetch(`/api/monthly-feedback/${s}`,{method:"DELETE",headers:{Authorization:`Bearer ${a}`}})).ok)n({title:"Deleted Successfully",description:"Monthly feedback has been deleted."}),o(!1),v();else throw new Error("Delete failed")}catch(a){n({variant:"destructive",title:"Delete Failed",description:"Failed to delete feedback. Please try again."})}}),H=()=>{v()};return e.jsxs("div",{className:"max-w-7xl mx-auto p-6 space-y-6",children:[u&&e.jsx(U,{onClick:u,variant:"outline",className:"mb-4 back-button",children:"← Back to Home"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-2",children:"Monthly Feedback Reports"}),e.jsx("p",{className:"text-muted-foreground",children:"Upload and manage monthly custodial feedback emails"})]}),e.jsxs(X,{defaultValue:"browse",className:"w-full",children:[e.jsxs(Z,{className:"grid w-full grid-cols-2",children:[e.jsxs(O,{value:"browse",children:[e.jsx(V,{className:"w-4 h-4 mr-2"}),"Browse Feedback"]}),e.jsx(O,{value:"upload",children:"Upload New Feedback"})]}),e.jsxs(B,{value:"browse",className:"space-y-6",children:[e.jsxs("div",{className:"space-y-4",role:"search",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[e.jsx("div",{className:"space-y-2",children:e.jsx(_,{placeholder:"Search by title, uploader, notes or month…",value:x,onChange:s=>C(s.target.value),className:"w-full","aria-label":"Search feedback by title, uploader, notes or month"})}),e.jsxs(F,{value:f,onValueChange:L,children:[e.jsx(N,{"aria-label":"Filter by school",children:e.jsx(k,{placeholder:"All Schools"})}),e.jsxs(A,{children:[e.jsx(c,{value:"all",children:"All Schools"}),te.map(s=>e.jsx(c,{value:s,title:J(s),children:s},s))]})]}),e.jsxs(F,{value:p,onValueChange:T,children:[e.jsx(N,{"aria-label":"Filter by year",children:e.jsx(k,{placeholder:"All Years"})}),e.jsxs(A,{children:[e.jsx(c,{value:"all",children:"All Years"}),z.map(s=>e.jsx(c,{value:s.toString(),children:s},s))]})]}),e.jsxs(F,{value:b,onValueChange:M,children:[e.jsx(N,{"aria-label":"Filter by month",children:e.jsx(k,{placeholder:"All Months"})}),e.jsxs(A,{children:[e.jsx(c,{value:"all",children:"All Months"}),le.map(s=>e.jsx(c,{value:s,children:s},s))]})]})]}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(U,{onClick:$,variant:"outline",size:"sm",className:"flex items-center gap-2",children:[e.jsx(K,{className:"w-4 h-4"}),"Clear Filters"]})})]}),m?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:"Loading feedback..."})}):S.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(V,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium mb-2",children:"No Feedback Found"}),e.jsx("p",{className:"text-muted-foreground",children:t.length===0?"No monthly feedback has been uploaded yet.":"No feedback matches your search criteria."})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Showing ",S.length," of ",t.length," feedback report",t.length!==1?"s":""]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:S.map(s=>e.jsx(ee,{feedback:s,onView:G,onDownload:W},s.id))})]})]}),e.jsx(B,{value:"upload",children:e.jsx(se,{onUploadSuccess:H})})]}),e.jsx(ae,{feedback:y,isOpen:r,onClose:()=>o(!1),onDelete:q,isAdmin:Y})]})}export{xe as default};
