---
phase: 06-pending-badge-freshness
plan: 03
type: execute
wave: 2
depends_on: [06-01, 06-02]
files_modified:
  - tests/integration/pending-badge.test.ts
autonomous: true
must_haves:
  truths:
    - Integration test verifies contract fix
    - Integration test verifies event emission
    - Both fixes work together end-to-end
  artifacts:
    - path: tests/integration/pending-badge.test.ts
      provides: Integration test for pending badge contract and freshness
  key_links:
    - from: Quick capture save
      to: Dashboard badge update
      via: API response + custom event
---

<objective>
Create integration test to verify the pending badge contract fix and freshness wiring work correctly end-to-end.
</objective>

<context>
**What to Test:**
1. API returns `totalRecords` in pagination
2. usePendingCount correctly reads `totalRecords`
3. Quick capture success emits `PENDING_COUNT_UPDATED_EVENT`
4. Dashboard receives event and refreshes count

**Test Scope:**
- Mock API response with `pagination.totalRecords`
- Verify usePendingCount extracts correct value
- Verify quick capture dispatches event
- Verify event listener receives and processes event
</context>

<implementation>
**Test Framework:** Existing test setup (Vitest/Jest)
**Test Location:** tests/integration/pending-badge.test.ts
**Test Cases:**
1. Contract: API totalRecords → hook totalRecords
2. Freshness: Quick capture → event emission
3. Integration: Full flow from capture to badge update
</implementation>

<tasks>

<task name="Create integration test file" type="auto">
<description>Create integration test for pending badge fixes</description>
<files>
- tests/integration/pending-badge.test.ts
</files>
<action>
1. Create test file with test cases:
   - Test API contract (totalRecords field)
   - Test event emission on quick capture
   - Test end-to-end flow
2. Mock fetch and window.dispatchEvent
3. Assert correct values and event dispatch
4. Save file
</action>
<verify>
- Test file exists and compiles
- Tests can be run with `npm test` or similar
- Tests pass (or are skipped if no test runner configured)
</verify>
<done>Integration tests created for pending badge fixes</done>
</task>

<task name="Run integration tests" type="auto">
<description>Execute the integration tests to verify fixes</description>
<action>
1. Run integration tests: `npm test tests/integration/pending-badge.test.ts` or similar
2. If tests fail, debug and fix
3. If no test runner, skip and document
</action>
<verify>
- All test assertions pass
- No console errors during test execution
</verify>
<done>Integration tests pass, fixes verified</done>
</task>

<task name="Create test summary" type="auto">
<description>Document test results in verification</description>
<action>
1. Document test coverage
2. Note any skipped tests or limitations
3. Update verification status
</action>
<verify>
- Test summary is complete
- All fixes are covered by tests
</verify>
<done>Integration testing complete</done>
</task>

</tasks>

<verification>
- Integration test file exists and passes
- Contract fix verified: totalRecords field used correctly
- Freshness fix verified: event emitted on quick capture
- End-to-end flow tested
</verification>

<success_criteria>
- [ ] Integration tests created and passing
- [ ] Contract fix verified by test
- [ ] Freshness fix verified by test
- [ ] Test summary documented
</success_criteria>
