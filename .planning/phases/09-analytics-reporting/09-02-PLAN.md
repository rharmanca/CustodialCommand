---
phase: 09-analytics-reporting
plan: "02"
type: execute
wave: 2
depends_on:
  - "09-01"
files_modified:
  - src/pages/analytics-dashboard.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Analytics Dashboard page is accessible from main navigation (admin section)"
    - "School Trends tab shows a line chart with monthly avg rating per school"
    - "School Comparison tab shows a bar chart comparing all schools side-by-side"
    - "CSV Export button triggers download of inspections.csv from the server"
    - "Date range / school filter inputs are debounced (300ms) before re-fetching"
    - "Charts use ResponsiveContainer (mobile-responsive, no overflow)"
    - "Page handles loading, empty, and error states gracefully"
  artifacts:
    - path: "src/pages/analytics-dashboard.tsx"
      provides: "Full analytics page with two tabs and CSV export"
      min_lines: 150
      contains: "PerformanceTrendChart"
    - path: "src/App.tsx"
      provides: "Analytics Dashboard route and nav entry"
      contains: "Analytics Dashboard"
  key_links:
    - from: "src/pages/analytics-dashboard.tsx"
      to: "/api/analytics/trends"
      via: "fetch with admin bearer token from session"
      pattern: "api/analytics/trends"
    - from: "src/pages/analytics-dashboard.tsx"
      to: "/api/analytics/comparison"
      via: "fetch with admin bearer token"
      pattern: "api/analytics/comparison"
    - from: "src/pages/analytics-dashboard.tsx"
      to: "/api/export/inspections.csv"
      via: "window.location or fetch with admin bearer token → blob download"
      pattern: "api/export/inspections"
---

<objective>
Build the Analytics Dashboard page wiring the three new API endpoints to the existing Recharts components.

Purpose: Supervisor-facing page for school performance trends, school comparison, and data export.
Output: analytics-dashboard.tsx page + App.tsx navigation entry.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/09-analytics-reporting/09-01-SUMMARY.md
@src/App.tsx
@src/components/charts/PerformanceTrendChart.tsx
@src/components/charts/SchoolComparisonChart.tsx
@src/pages/scores-dashboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics-dashboard.tsx page</name>
  <files>src/pages/analytics-dashboard.tsx</files>
  <action>
Create a new page component following the scores-dashboard.tsx pattern.

**State:**
- `activeTab: 'trends' | 'comparison'`
- `school: string` (for trends tab; default to first school or '')
- `months: number` (default 6)
- `startDate: string`, `endDate: string` (for comparison tab; default last 90 days)
- `trendsData: Array<{ month: string; avgRating: number; inspectionCount: number }>` 
- `comparisonData: Array<{ school: string; avgRating: number; inspectionCount: number; completedCount: number }>`
- `loading: boolean`, `error: string | null`

**Auth:** Read admin session token from sessionStorage key `adminToken` (same pattern as admin-inspections.tsx). Include as `Authorization: Bearer ${token}` header on all fetch calls. If no token, show "Admin login required" message.

**Debounce:** Use a `useEffect` with `setTimeout` (300ms) on school/months/dates changes before fetching. Cancel timer on cleanup.

**Trends tab:**
- School selector (`<select>`) populated from comparisonData schools
- Months selector (3, 6, 12, 24)
- `<PerformanceTrendChart>` from `@/components/charts/PerformanceTrendChart` — map API response to `{ date: row.month, averageRating: row.avgRating, totalInspections: row.inspectionCount }`

**Comparison tab:**
- Date range inputs (startDate, endDate)
- `<SchoolComparisonChart>` from `@/components/charts/SchoolComparisonChart` — map API response to `{ school, averageRating: avgRating, totalInspections: inspectionCount, singleRoomCount: 0, wholeBuildingCount: 0 }`

**CSV Export (visible on both tabs):**
- Button labeled "Export CSV"
- On click: build URL `/api/export/inspections.csv` with optional school/startDate/endDate query params matching current filters
- Fetch with admin auth header, get response as blob, create object URL, trigger `<a>` download, revoke URL
- Show loading state on button during download

**Layout:** Use Card/CardHeader/CardContent from @/components/ui/card, Tabs/TabsList/TabsTrigger/TabsContent from @/components/ui/tabs (shadcn). Export button in CardHeader actions area. Mobile-responsive: full-width on mobile.

**Error/empty states:** Show Alert component if API returns error. Show "No data for selected filters" if array is empty.
  </action>
  <verify>npm run check 2>&1 | grep -E "analytics-dashboard" | head -5</verify>
  <done>File exists with 150+ lines; TypeScript check passes; component renders without TS errors; contains PerformanceTrendChart and SchoolComparisonChart imports; CSV fetch pattern present</done>
</task>

<task type="auto">
  <name>Task 2: Wire analytics page into App.tsx navigation</name>
  <files>src/App.tsx</files>
  <action>
Add Analytics Dashboard to App.tsx:

1. **Lazy import** (with existing lazy imports ~line 54):
```typescript
const AnalyticsDashboard = lazy(() => import("./pages/analytics-dashboard"));
```

2. **Page union type** — add `"Analytics Dashboard"` to the `currentPage` useState type (the union type starting ~line 115).

3. **Route case** — in the `switch(currentPage)` or equivalent rendering block, add:
```typescript
case "Analytics Dashboard":
  return <AnalyticsDashboard onBack={() => setCurrentPage("Custodial")} />;
```

4. **Navigation entry** — find where admin navigation links are defined (search for `"admin-inspections"` or `"Scores Dashboard"` in nav link arrays). Add Analytics Dashboard entry adjacent to Scores Dashboard:
```typescript
{ name: "Analytics Dashboard", path: "Analytics Dashboard", icon: TrendingUp }
```
(Import `TrendingUp` from `lucide-react` if not already imported — check existing imports first.)

5. **Screen reader page names** — add `"Analytics Dashboard": "Analytics Dashboard"` to the `pageNames` record (~line 223).
  </action>
  <verify>npm run check 2>&1 | grep -c "error" || echo "0 errors"; grep -n "Analytics Dashboard" src/App.tsx | wc -l</verify>
  <done>TypeScript check passes; `grep "Analytics Dashboard" src/App.tsx` returns 4+ matches (import, type, case, nav entry, pageNames); app builds without error</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Analytics Dashboard page with:
    - School Trends tab: line chart of monthly avg ratings per school
    - School Comparison tab: bar chart of all schools
    - CSV Export button that downloads inspections.csv
    - Admin auth required (redirects/shows message if not logged in)
    - Mobile-responsive charts
  </what-built>
  <how-to-verify>
    1. Start dev server: `npm run dev`
    2. Log in as admin
    3. Navigate to Analytics Dashboard from main nav
    4. Trends tab: select a school → chart loads with monthly data points
    5. Comparison tab: all schools shown side-by-side → bar chart renders
    6. CSV Export: click button → file downloads → open in spreadsheet, verify rows
    7. Resize window to mobile width → charts don't overflow, layout stacks vertically
    8. Without admin token (open incognito) → "Admin login required" message shown
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run check` passes with 0 TypeScript errors
2. `grep -n "Analytics Dashboard" src/App.tsx` returns ≥4 matches
3. `grep -n "PerformanceTrendChart\|SchoolComparisonChart" src/pages/analytics-dashboard.tsx` returns 2 matches
4. `grep -n "api/export/inspections.csv" src/pages/analytics-dashboard.tsx` returns 1 match
5. `grep -n "Authorization.*Bearer" src/pages/analytics-dashboard.tsx` returns 1+ matches
6. Human approves chart rendering and CSV download at checkpoint
</verification>

<success_criteria>
- Analytics Dashboard page exists and is reachable from main navigation
- Trends tab renders PerformanceTrendChart with real API data
- Comparison tab renders SchoolComparisonChart with real API data
- CSV Export downloads a valid file
- Admin auth enforced — unauthenticated users see error, not crash
- Mobile-responsive (ResponsiveContainer, no overflow)
- Human checkpoint: "approved"
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-reporting/09-02-SUMMARY.md`
</output>
