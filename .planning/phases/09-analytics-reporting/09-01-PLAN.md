---
phase: 09-analytics-reporting
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - server/storage.ts
  - server/routes.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/analytics/trends?school=X&months=6 returns monthly avg ratings aggregated in SQL"
    - "GET /api/analytics/comparison?startDate=&endDate= returns per-school summary aggregated in SQL"
    - "GET /api/export/inspections.csv streams a CSV file directly (no in-memory array)"
    - "All three endpoints require admin auth (Bearer token)"
    - "Zero JS-side aggregation — all GROUP BY, AVG, COUNT happen at DB layer"
  artifacts:
    - path: "server/storage.ts"
      provides: "Three analytics query functions: getSchoolTrends, getSchoolComparison, streamInspectionsCsv"
      contains: "GROUP BY"
    - path: "server/routes.ts"
      provides: "Three new API routes under /api/analytics/* and /api/export/*"
      contains: "/api/analytics/trends"
  key_links:
    - from: "server/routes.ts"
      to: "server/storage.ts"
      via: "storage.getSchoolTrends / storage.getSchoolComparison / storage.getInspectionsCsvRows"
      pattern: "storage\\.(getSchoolTrends|getSchoolComparison|getInspectionsCsvRows)"
    - from: "server/storage.ts"
      to: "PostgreSQL inspections table"
      via: "Drizzle sql<> template with GROUP BY"
      pattern: "sql`.*GROUP BY"
---

<objective>
Build the analytics data layer: three SQL-aggregated API endpoints for school trends, school comparison, and CSV export.

Purpose: All analytics data must come from DB-layer aggregation (GROUP BY/AVG/COUNT), never JS aggregation, due to 93% memory baseline.
Output: Three new API routes + corresponding storage query functions.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/research/ARCHITECTURE.md
@.planning/research/PITFALLS.md
@server/storage.ts
@server/routes.ts
@shared/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics query functions to storage.ts</name>
  <files>server/storage.ts</files>
  <action>
Add three new query functions to the `storage` object (following the existing `executeQuery` wrapper pattern):

**1. `getSchoolTrends(school: string, months: number = 6)`**
Returns monthly average rating data for a specific school using SQL GROUP BY.
Use `sql<>` Drizzle template:
```sql
SELECT
  to_char(date_trunc('month', created_at), 'YYYY-MM') AS month,
  ROUND(AVG(
    (COALESCE(floors,0) + COALESCE(vertical_horizontal_surfaces,0) + COALESCE(ceiling,0) +
     COALESCE(restrooms,0) + COALESCE(customer_satisfaction,0) + COALESCE(trash,0) +
     COALESCE(project_cleaning,0) + COALESCE(activity_support,0) + COALESCE(safety_compliance,0) +
     COALESCE(equipment,0) + COALESCE(monitoring,0)) /
    NULLIF((CASE WHEN floors IS NOT NULL THEN 1 ELSE 0 END + ...), 0)
  )::numeric, 2) AS avg_rating,
  COUNT(*) AS inspection_count
FROM inspections
WHERE school = $1
  AND status = 'completed'
  AND created_at >= NOW() - INTERVAL '$2 months'
GROUP BY date_trunc('month', created_at)
ORDER BY date_trunc('month', created_at)
```
Return type: `Array<{ month: string; avgRating: number; inspectionCount: number }>`.

Since the rating calculation is complex, simplify to average all non-null rating columns using:
```typescript
const ratingCols = ['floors','verticalHorizontalSurfaces','ceiling','restrooms',
  'customerSatisfaction','trash','projectCleaning','activitySupport',
  'safetyCompliance','equipment','monitoring'];
```
Use `sql<>` with `NULLIF` to avoid division by zero when inspections have no ratings.

Cache key: `analytics_trends_${school}_${months}`, TTL: 10 minutes.

**2. `getSchoolComparison(startDate?: string, endDate?: string)`**
Returns one row per school with aggregate stats. Same rating average pattern as above but GROUP BY school.
Return type: `Array<{ school: string; avgRating: number; inspectionCount: number; completedCount: number }>`.
Cache key: `analytics_comparison_${startDate}_${endDate}`, TTL: 10 minutes.

**3. `getInspectionsCsvRows(school?: string, startDate?: string, endDate?: string)`**
Returns raw inspection rows for CSV streaming (NOT aggregated). Select only: id, school, date, inspectorName, inspectionType, locationDescription, status, createdAt, and all 11 rating columns. Apply filters (school, date range, status='completed'). Limit to 5000 rows maximum to prevent memory spike.
Return type: Array of plain inspection objects.
Cache: none (streaming export, skip cache).
  </action>
  <verify>npx tsx -e "import { storage } from './server/storage'; storage.getSchoolComparison().then(r => console.log('OK', r.length)).catch(e => console.error(e))" 2>/dev/null || npm run check 2>&1 | grep -E "error|warning" | head -10</verify>
  <done>TypeScript compiles without error; three query functions exported from storage object; all use sql<> GROUP BY patterns (grep confirms "GROUP BY" in storage.ts)</done>
</task>

<task type="auto">
  <name>Task 2: Add analytics API routes to routes.ts</name>
  <files>server/routes.ts</files>
  <action>
Add three new routes after the existing `/api/scores/:school` route (~line 2100). All three require admin auth middleware (`requireAdminAuth`).

**Route 1: GET /api/analytics/trends**
```
Query params: school (required), months (optional, default 6, max 24)
Auth: requireAdminAuth middleware
Call: storage.getSchoolTrends(school, months)
Response: { success: true, data: [...], meta: { school, months } }
Validation: school must be non-empty string; months must be 1-24
```

**Route 2: GET /api/analytics/comparison**
```
Query params: startDate (optional YYYY-MM-DD), endDate (optional YYYY-MM-DD)
Auth: requireAdminAuth middleware
Call: storage.getSchoolComparison(startDate, endDate)
Response: { success: true, data: [...], meta: { startDate, endDate } }
```

**Route 3: GET /api/export/inspections.csv**
```
Query params: school (optional), startDate (optional), endDate (optional)
Auth: requireAdminAuth middleware
Response: stream CSV (NOT JSON)
  res.setHeader('Content-Type', 'text/csv; charset=utf-8')
  res.setHeader('Content-Disposition', 'attachment; filename="inspections.csv"')
  Write header row: id,school,date,inspectorName,inspectionType,location,status,floors,vhSurfaces,ceiling,restrooms,custSatisfaction,trash,projectCleaning,activitySupport,safetyCompliance,equipment,monitoring,createdAt
  Stream rows from storage.getInspectionsCsvRows(school, startDate, endDate)
  Escape values: wrap in quotes, escape internal quotes as ""
  Call res.end() when done
```

Use existing `requireAdminAuth` middleware pattern already in routes.ts (find by searching for existing admin-protected routes).

Add all three to the endpoint list comment block at the bottom of registerRoutes.
  </action>
  <verify>npm run check 2>&1 | grep -c "error" || echo "0 errors"</verify>
  <done>TypeScript check passes (0 errors); three new routes visible in routes.ts; all three have requireAdminAuth applied; CSV route sets Content-Type text/csv and streams (no res.json call)</done>
</task>

</tasks>

<verification>
1. `npm run check` passes with 0 TypeScript errors
2. `grep -n "GROUP BY" server/storage.ts` returns 2+ matches (trends and comparison queries)
3. `grep -n "getSchoolTrends\|getSchoolComparison\|getInspectionsCsvRows" server/routes.ts` returns 3 matches
4. `grep -n "text/csv" server/routes.ts` returns 1 match (CSV export route)
5. `grep -n "requireAdminAuth" server/routes.ts` shows all 3 new routes are protected
</verification>

<success_criteria>
- Three analytics storage functions exist: getSchoolTrends, getSchoolComparison, getInspectionsCsvRows
- All aggregation happens in SQL (GROUP BY, AVG, COUNT) — zero JS aggregation
- Three API routes exist: GET /api/analytics/trends, GET /api/analytics/comparison, GET /api/export/inspections.csv
- All routes require admin auth
- CSV route streams (sets Content-Type text/csv, calls res.write, then res.end)
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/09-analytics-reporting/09-01-SUMMARY.md`
</output>
