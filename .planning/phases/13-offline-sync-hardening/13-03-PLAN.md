---
phase: 13-offline-sync-hardening
plan: 03
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/components/ui/pending-uploads.tsx
  - src/components/ui/pending-upload-card.tsx
  - src/pages/Dashboard.tsx
  - src/hooks/usePendingUploads.ts
autonomous: false
must_haves:
  truths:
    - User can view queue of pending uploads from Dashboard
    - Queue shows location, timestamp, and status for each item
    - User can manually trigger sync retry
    - Queue updates in real-time as items sync
  artifacts:
    - path: src/components/ui/pending-uploads.tsx
      provides: Pending uploads queue component
      exports: ["PendingUploads"]
    - path: src/components/ui/pending-upload-card.tsx
      provides: Individual pending item card
      exports: ["PendingUploadCard"]
    - path: src/hooks/usePendingUploads.ts
      provides: Pending uploads data hook
      exports: ["usePendingUploads"]
    - path: src/pages/Dashboard.tsx
      provides: Dashboard with pending uploads section
      contains: "PendingUploads"
  key_links:
    - from: src/components/ui/pending-uploads.tsx
      to: src/hooks/usePendingUploads.ts
      via: hook consumption
      pattern: "usePendingUploads"
    - from: src/components/ui/pending-uploads.tsx
      to: src/components/ui/pending-upload-card.tsx
      via: component import
      pattern: "import.*PendingUploadCard"
    - from: src/pages/Dashboard.tsx
      to: src/components/ui/pending-uploads.tsx
      via: component usage
      pattern: "<PendingUploads"
---

<objective>
Create pending upload queue visibility UI showing offline captures waiting to sync, with user controls for manual retry.

Purpose: Custodial staff need visibility into what captures are pending upload to ensure confidence their work is preserved. The queue shows location, timestamp, and status, with manual retry for failed items.

Output: Pending uploads queue component integrated into Dashboard with real-time updates.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-offline-sync-hardening/13-CONTEXT.md
@.planning/phases/13-offline-sync-hardening/13-RESEARCH.md
@src/utils/offlineManager.ts
@src/components/ui/offline-status.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePendingUploads hook</name>
  <files>src/hooks/usePendingUploads.ts</files>
  <action>Create usePendingUploads custom hook:

1. Query IndexedDB for pending items:
   - Photos with status 'pending' from PhotoManager
   - Forms with status 'pending' from OfflineFormManager
   - Combine into unified UploadItem interface

2. UploadItem interface:
```typescript
interface UploadItem {
  id: string;
  type: 'photo' | 'form';
  location: string;  // School name or "Quick Capture"
  timestamp: Date;
  status: 'pending' | 'syncing' | 'failed' | 'synced';
  retryCount: number;
  size?: number;  // For photos
  error?: string; // For failed items
}
```

3. Hook return:
```typescript
interface PendingUploadsState {
  items: UploadItem[];
  totalCount: number;
  pendingCount: number;
  failedCount: number;
  syncingCount: number;
  refresh: () => Promise<void>;
  retryItem: (id: string) => Promise<void>;
  retryAll: () => Promise<void>;
}
```

4. Features:
   - Poll for updates every 5 seconds
   - Listen for service worker messages (FORM_SYNC_SUCCESS, PHOTO_SYNC_SUCCESS)
   - Sort items by timestamp (newest first)
   - Expose retry methods using offlineManager

5. Use existing IndexedDB access patterns from sw.js

6. Export hook: `export function usePendingUploads(): PendingUploadsState`</action>
  <verify>npm run check passes, hook returns correct types</verify>
  <done>Hook created with polling, service worker integration, retry methods</done>
</task>

<task type="auto">
  <name>Task 2: Create PendingUploadCard component</name>
  <files>src/components/ui/pending-upload-card.tsx</files>
  <action>Create PendingUploadCard component:

1. Props:
```typescript
interface PendingUploadCardProps {
  item: UploadItem;
  onRetry: (id: string) => Promise<void>;
}
```

2. Display content:
   - Type icon: Camera for photos, FileText for forms
   - Location name (school or "Quick Capture")
   - Timestamp (relative: "2 min ago", "1 hour ago")
   - Status badge with color coding:
     - Pending: amber badge
     - Syncing: amber spinner
     - Failed: red badge with error text
     - Synced: green checkmark (fades out after 3s)

3. Actions:
   - Retry button for failed items (visible only when status='failed')
   - 44px touch target
   - Loading state during retry

4. Styling:
   - Card with subtle border
   - Compact padding (p-3)
   - Mobile-first (full width, stack layout)
   - Photo items show file size (e.g., "3.2 MB")

5. Visual states:
   - Syncing: subtle pulse animation on icon
   - Failed: red border highlight
   - Just synced: green flash animation then remove

6. Accessibility:
   - aria-label with item details
   - role="listitem"
   - Retry button has descriptive aria-label</action>
  <verify>npm run check passes, component renders all states</verify>
  <done>Card component with 4 status states, retry button, animations</done>
</task>

<task type="auto">
  <name>Task 3: Create PendingUploads component</name>
  <files>src/components/ui/pending-uploads.tsx</files>
  <action>Create PendingUploads component:

1. Props:
```typescript
interface PendingUploadsProps {
  maxItems?: number;  // Default 10, show "+X more" if exceeded
  showHeader?: boolean;  // Default true
  collapsible?: boolean;  // Default true on mobile
}
```

2. Header section:
   - Title: "Pending Uploads" with count badge
   - "Sync Now" button (triggers manual sync)
   - Expand/collapse toggle (if collapsible)

3. Content area:
   - List of PendingUploadCard components
   - Empty state: "All uploads complete ✓"
   - Loading state: spinner while fetching

4. Footer actions:
   - "Retry All Failed" button (only if failed items exist)
   - Last synced timestamp
   - Total storage used by pending items

5. States:
   - Empty: show checkmark + "You're all caught up"
   - Has items: scrollable list (max-height: 400px)
   - Collapsed: show count badge only

6. Integration:
   - Use usePendingUploads hook
   - Pass onRetry to each card
   - Handle Sync Now button (call offlineManager.forceSyncAll())

7. Styling:
   - Card container with shadow
   - Scrollbar styling for list
   - Mobile: full width, collapsible
   - Desktop: fixed width (400px max)</action>
  <verify>npm run check passes, all states render</verify>
  <done>Component with header, list, footer, empty state, collapsible</done>
</task>

<task type="auto">
  <name>Task 4: Integrate into Dashboard</name>
  <files>src/pages/Dashboard.tsx</files>
  <action>Add PendingUploads to Dashboard:

1. Placement:
   - Below Review section, above Analyze section
   - Show only when pending items exist OR recently had items
   - Collapsible: expanded by default if items pending, collapsed if empty

2. Implementation:
   - Import PendingUploads component
   - Place in grid layout (full width on mobile, side column on desktop)
   - Pass appropriate props:
     - maxItems: 5 (show "+X more" if exceeded)
     - showHeader: true
     - collapsible: true

3. Layout considerations:
   - Mobile: full width, stacked below Review
   - Desktop: place in right column or below Review
   - Ensure spacing consistent with other sections

4. Reference existing Dashboard layout from Phase 12

5. Example integration:
```tsx
{/* Review Section */}
<ReviewSection />

{/* Pending Uploads - only show if relevant */}
<PendingUploads maxItems={5} collapsible />

{/* Analyze Section */}
<AnalyzeSection />
```

6. Ensure component doesn't break layout if empty</action>
  <verify>npm run check passes, Dashboard renders</verify>
  <done>PendingUploads integrated into Dashboard, responsive layout</done>
</task>

</tasks>

<checkpoint:human-verify gate="blocking">
  <what-built>Pending uploads queue UI showing offline captures waiting to sync, with manual retry controls</what-built>
  <how-to-verify>
    1. Open Dashboard and verify Pending Uploads section visible
    2. Turn off WiFi
    3. Create a Quick Capture with photos
    4. Verify:
       - Capture saves successfully (shows "saved offline" message)
       - Pending Uploads section appears/updates
       - Item shows in queue with correct location
       - Timestamp is correct
       - Status shows "pending"
    5. Turn WiFi back on
    6. Verify:
       - Status changes to "syncing" then "synced"
       - Item disappears from queue (or fades out)
    7. Simulate failed sync (can block URL in devtools):
       - Verify "failed" status with retry button
       - Click retry, verify it attempts sync
    8. Check mobile view: queue is usable, touch targets work
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</checkpoint:human-verify>

<verification>
- [ ] Dashboard shows Pending Uploads section
- [ ] Offline captures appear in queue
- [ ] Location and timestamp display correctly
- [ ] Status updates (pending → syncing → synced)
- [ ] Failed items show retry button
- [ ] Retry works and re-attempts sync
- [ ] "Sync Now" button triggers manual sync
- [ ] Empty state shows when no pending items
- [ ] Mobile view is usable
- [ ] npm run check passes
</verification>

<success_criteria>
1. User can view queue of pending uploads from Dashboard
2. Queue shows correct location, timestamp, and status
3. User can manually retry failed items
4. Queue updates in real-time as items sync
5. Empty state shown when no pending items
6. Mobile-friendly with proper touch targets
</success_criteria>

<output>
After completion, create `.planning/phases/13-offline-sync-hardening/13-03-SUMMARY.md`
</output>
