---
phase: 10-notifications-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - server/notificationService.ts
  - server/index.ts
  - server/routes.ts
  - .env.example
autonomous: true
user_setup:
  - service: resend
    why: "Email delivery API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
      - name: ALERT_RECIPIENT
        source: "Hardcoded: rharman@collegiateacademies.org"
must_haves:
  truths:
    - "Facility manager receives email when pending backlog exceeds threshold"
    - "Alert fires only once per 24 hours (cooldown prevents spam)"
    - "Scheduled daily at 8am on weekdays only"
    - "Email includes pending count, school breakdown, and review link"
  artifacts:
    - path: "server/notificationService.ts"
      provides: "Notification logic with query, threshold check, email sending"
      min_lines: 150
      exports: ["scheduleNotifications", "sendAlertIfNeeded", "getPendingInspectionStats"]
    - path: "server/routes.ts"
      provides: "Manual trigger endpoint POST /api/notifications/trigger"
      contains: "notification trigger route"
  key_links:
    - from: "server/index.ts"
      to: "server/notificationService.ts"
      via: "scheduleNotifications() call on startup"
      pattern: "scheduleNotifications|notificationService"
    - from: "server/notificationService.ts"
      to: "storage.ts"
      via: "db.select query for pending inspections"
      pattern: "eq\\(inspections.status.*pending_review"
---

<objective>
Implement email alert system using Resend API that notifies the facility manager when inspection backlog exceeds configured threshold (10 pending OR 48h oldest).

Purpose: Enable proactive backlog management without requiring manual checking
Output: Scheduled daily alert with 24h cooldown, HTML email with school breakdown
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
</execution_context>

<context>
@.planning/phases/10-notifications-alerts/10-CONTEXT.md
@.planning/phases/10-notifications-alerts/10-RESEARCH.md
@.planning/codebase/STACK.md
@.planning/codebase/ARCHITECTURE.md
@server/storage.ts
@shared/schema.ts
@server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies (resend, node-cron)</name>
  <files>package.json</files>
  <action>
    Install `resend` and `node-cron` packages:
    ```bash
    npm install resend node-cron
    npm install --save-dev @types/node-cron
    ```
    
    Verify package.json shows both in dependencies section.
    
    Note: resend@latest is ESM-compatible and works with the existing ES module setup.
  </action>
  <verify>npm list resend node-cron | grep -E "resend|node-cron"</verify>
  <done>Both packages installed and listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create notification service with query, threshold, email, cooldown</name>
  <files>server/notificationService.ts, .env.example</files>
  <action>
    Create `server/notificationService.ts` implementing:
    
    1. **getPendingInspectionStats()**: Query pending inspections
       - Use `db.select({ count: count(), school: inspections.school, oldest: sql\`MIN(${inspections.captureTimestamp})` })`
       - Filter: `where(eq(inspections.status, 'pending_review'))`
       - Group by school for breakdown
    
    2. **checkThreshold(stats)**: Return true if threshold exceeded
       - Count >= 10 OR oldest > 48 hours (172800000 ms)
    
    3. **shouldSendAlert()**: Check 24h cooldown via file
       - Store last sent timestamp in `.notification-cooldown`
       - Return false if within 24h, true otherwise
    
    4. **recordAlertSent()**: Update cooldown file with current timestamp
    
    5. **sendNotificationEmail(stats)**: Send HTML email via Resend
       - From: "Custodial Command <alerts@cacustodialcommand.up.railway.app>"
       - To: process.env.ALERT_RECIPIENT (fallback to hardcoded)
       - Subject: "[Custodial Command] {count} inspections pending review"
       - HTML: Mobile-friendly template with school breakdown list
       - Include direct link to /review page
    
    6. **sendAlertIfNeeded()**: Orchestrate the flow
       - Get stats -> Check threshold -> Check cooldown -> Send email -> Record sent
       - Log all actions via logger.info/logger.error
       - Catch errors gracefully (don't crash app)
    
    7. **scheduleNotifications()**: Initialize cron job
       - Schedule: `0 8 * * 1-5` (8am, weekdays only)
       - Timezone: 'America/Chicago'
       - Callback: sendAlertIfNeeded()
       - Log when scheduler starts
    
    Also update `.env.example` adding:
    ```
    # Notifications (Resend)
    RESEND_API_KEY=your_resend_api_key_here
    ALERT_RECIPIENT=rharman@collegiateacademies.org
    ```
    
    Import patterns:
    - `import { Resend } from 'resend';`
    - `import cron from 'node-cron';`
    - Import db, inspections from existing files
    
    Error handling:
    - If RESEND_API_KEY missing: log warning, skip email sending
    - If query fails: log error, don't send alert
    - If email fails: log error, don't record cooldown
  </action>
  <verify>grep -E "scheduleNotifications|sendAlertIfNeeded|resend|node-cron" server/notificationService.ts | head -20</verify>
  <done>notificationService.ts exists with all 7 functions, imports Resend and node-cron, implements query/threshold/cooldown/email logic</done>
</task>

<task type="auto">
  <name>Task 3: Integrate scheduler into server startup and add manual trigger endpoint</name>
  <files>server/index.ts, server/routes.ts</files>
  <action>
    **Part A: server/index.ts**
    Import and call scheduleNotifications() after server starts:
    ```typescript
    import { scheduleNotifications } from './notificationService.js';
    
    // After app.listen()
    scheduleNotifications();
    logger.info('Notification scheduler initialized');
    ```
    
    **Part B: server/routes.ts**
    Add manual trigger endpoint for testing:
    ```typescript
    import { sendAlertIfNeeded } from './notificationService.js';
    
    // POST /api/notifications/trigger
    // Protected by admin auth middleware
    // Calls sendAlertIfNeeded() and returns result
    // Response: { success: true, sent: boolean, message: string }
    ```
    
    Add route after other admin routes:
    ```typescript
    app.post('/api/notifications/trigger', adminAuthMiddleware, asyncErrorHandler(async (req, res) => {
      const result = await sendAlertIfNeeded();
      res.json({ 
        success: true, 
        sent: result.sent,
        message: result.sent ? 'Alert sent' : 'No alert needed (below threshold or in cooldown)'
      });
    }));
    ```
    
    Verify imports use `.js` extension (Node ESM requirement).
  </action>
  <verify>grep -n "scheduleNotifications\|notificationService\|/api/notifications/trigger" server/index.ts server/routes.ts</verify>
  <done>Server startup calls scheduleNotifications(), routes.ts has POST /api/notifications/trigger endpoint with admin auth</done>
</task>

</tasks>

<verification>
**Automated Checks:**
1. TypeScript compiles: `npm run check` passes
2. Dependencies installed: `npm list resend node-cron` succeeds
3. Service file exports all required functions
4. Route endpoint registered
5. No syntax errors in notificationService.ts

**Manual Verification (via API):**
```bash
# Trigger alert manually (requires admin auth)
curl -X POST https://cacustodialcommand.up.railway.app/api/notifications/trigger \
  -H "Cookie: connect.sid=YOUR_SESSION"
```

**Expected Response:**
```json
{ "success": true, "sent": true/false, "message": "..." }
```
</verification>

<success_criteria>
**Observable Completion:**
- [ ] POST /api/notifications/trigger endpoint returns success response
- [ ] Server logs show "Notification scheduler initialized" on startup
- [ ] Manual trigger checks threshold and cooldown correctly
- [ ] Email sends when threshold exceeded and cooldown clear
- [ ] 24h cooldown prevents duplicate alerts

**Files Exist:**
- [ ] server/notificationService.ts with 7 exported functions
- [ ] package.json includes resend and node-cron
- [ ] server/index.ts calls scheduleNotifications()
- [ ] server/routes.ts has /api/notifications/trigger endpoint
- [ ] .env.example has RESEND_API_KEY placeholder
</success_criteria>

<output>
After completion, create `.planning/phases/10-notifications-alerts/10-01-SUMMARY.md`
</output>
