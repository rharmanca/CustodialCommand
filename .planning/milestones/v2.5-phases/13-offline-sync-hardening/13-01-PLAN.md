---
phase: 13-offline-sync-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/offlineManager.ts
  - src/utils/photoStorage.ts
  - src/utils/storageQuota.ts
  - src/components/ui/storage-warning.tsx
autonomous: true
must_haves:
  truths:
    - User receives warning when offline storage reaches 80% capacity
    - Old synced items are automatically pruned to prevent storage exhaustion
    - Storage usage is monitored and displayed to user
    - Quick Capture continues working even when storage is near capacity
  artifacts:
    - path: src/utils/storageQuota.ts
      provides: Storage quota monitoring and management
      exports: ["checkStorageQuota", "getStorageUsage", "pruneOldItems"]
    - path: src/components/ui/storage-warning.tsx
      provides: User-facing storage warning component
      exports: ["StorageWarning"]
    - path: src/utils/offlineManager.ts
      provides: Updated with quota checks and auto-prune
      min_lines: 50
  key_links:
    - from: src/utils/offlineManager.ts
      to: src/utils/storageQuota.ts
      via: import and quota check calls
      pattern: "import.*storageQuota|checkStorageQuota"
    - from: src/components/ui/storage-warning.tsx
      to: src/utils/storageQuota.ts
      via: hook usage
      pattern: "useStorageQuota|getStorageUsage"
---

<objective>
Implement storage quota management for offline data to prevent storage exhaustion and ensure reliable Quick Capture functionality.

Purpose: Photos can quickly fill device storage (3-5MB each). Without quota management, users may lose the ability to save captures offline when storage is full. This plan adds proactive monitoring, user warnings at 80% capacity, and automatic pruning of old synced items.

Output: Storage quota monitoring system with warning UI and auto-prune functionality.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-offline-sync-hardening/13-CONTEXT.md
@.planning/phases/13-offline-sync-hardening/13-RESEARCH.md
@src/utils/offlineManager.ts
@src/utils/photoStorage.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage quota utilities</name>
  <files>src/utils/storageQuota.ts</files>
  <action>Create storage quota management utilities with:

1. `checkStorageQuota()` function that:
   - Returns current usage, available space, and percentage used
   - Estimates based on IndexedDB data + localStorage
   - Returns warning threshold status (80%)

2. `getStorageUsage()` function that:
   - Queries IndexedDB for all stored photos
   - Calculates total size from photo metadata
   - Returns { used, available, percentage, warning: boolean }

3. `pruneOldItems()` function that:
   - Finds synced items older than configurable age (default 7 days)
   - Removes oldest synced items first to free up space
   - Returns count of items pruned
   - Respects minimum retention (keep last 50 items minimum)

4. `requestPersistentStorage()` function that:
   - Requests persistent storage permission from browser
   - Prevents storage eviction by browser
   - Returns success/failure status

Use existing PhotoManager patterns from public/sw.js for IndexedDB access. Target is 80% warning threshold per CONTEXT.md decisions.</action>
  <verify>npm run check passes, no TypeScript errors</verify>
  <done>File created with all 4 exported functions, TypeScript types defined, IndexedDB integration working</done>
</task>

<task type="auto">
  <name>Task 2: Update offlineManager with quota checks</name>
  <files>src/utils/offlineManager.ts</files>
  <action>Update offlineManager.ts to integrate storage quota management:

1. Import storage quota utilities
2. Add quota check before saving photos in `savePhoto()`:
   - If quota > 80%, emit 'storageWarning' event
   - If quota > 95%, trigger auto-prune and retry
   - If still insufficient after prune, throw quota exceeded error

3. Add auto-prune on initialization:
   - Call pruneOldItems() during initialize()
   - Emit 'pruned' event with count of items removed

4. Add `checkQuota()` public method:
   - Returns current quota status
   - Triggers warning event if threshold exceeded

5. Update config defaults:
   - Add quotaWarningThreshold: 0.8 (80%)
   - Add quotaCriticalThreshold: 0.95 (95%)
   - Add minRetentionCount: 50

Maintain backward compatibility with existing event emitter pattern.</action>
  <verify>npm run check passes, imports resolve correctly</verify>
  <done>offlineManager.ts updated with quota integration, all existing methods preserved, new quota methods added</done>
</task>

<task type="auto">
  <name>Task 3: Create StorageWarning component</name>
  <files>src/components/ui/storage-warning.tsx</files>
  <action>Create StorageWarning React component:

1. Display storage usage with:
   - Progress bar showing used/total
   - Percentage text
   - Color coding: green (<80%), amber (80-95%), red (>95%)

2. Show warning message when threshold exceeded:
   - Amber warning: "Storage at X%. Old synced items will be auto-removed."
   - Red alert: "Storage critical. Some photos may not save."

3. Include "Manage Storage" button that:
   - Opens modal with list of pending/synced items
   - Allows manual deletion of synced items
   - Shows item age and size

4. Use Tailwind for styling:
   - Compact card design
   - Mobile-friendly touch targets (44px+)
   - Match existing amber/red color scheme

5. Export hook `useStorageQuota()` that:
   - Polls quota status every 30 seconds
   - Returns current quota + warning status
   - Re-renders component on changes

Follow existing component patterns from offline-status.tsx.</action>
  <verify>npm run check passes, component renders without errors</verify>
  <done>Component created with progress bar, color-coded states, modal for storage management, hook for polling</done>
</task>

</tasks>

<verification>
- [ ] StorageWarning component displays correctly
- [ ] Quota check triggers at 80% threshold
- [ ] Auto-prune removes oldest synced items
- [ ] Quick Capture works when storage warning shown
- [ ] Manual storage management modal opens
- [ ] npm run check passes
- [ ] npm run build succeeds
</verification>

<success_criteria>
1. User sees storage warning when offline data reaches 80% capacity
2. Old synced items are automatically pruned before storage exhaustion
3. Quick Capture continues working with graceful degradation
4. Manual storage management allows user control over synced data
</success_criteria>

<output>
After completion, create `.planning/phases/13-offline-sync-hardening/13-01-SUMMARY.md`
</output>
