---
phase: 03-workflow-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/schema.ts
  - server/db/migrations/
autonomous: true

must_haves:
  truths:
    - Inspection records can have status 'pending_review', 'completed', or 'discarded'
    - Quick captures track separate capture and completion timestamps
    - Quick notes field exists for optional context (max 200 chars)
    - Existing inspection data remains intact after migration
  artifacts:
    - path: shared/schema.ts
      provides: status field, captureTimestamp, completionTimestamp, quickNotes fields
      min_lines: 10
    - path: server/db/migrations/
      provides: Migration adding new fields to inspections table
  key_links:
    - from: shared/schema.ts
      to: inspections table
      via: Drizzle ORM schema definition
      pattern: status.*default.*pending_review
---

<objective>
Extend the inspections database schema to support pending review workflow state.

Purpose: Enable tracking of inspections that were captured quickly (photos only) but not yet fully reviewed with ratings and detailed notes.

Output: Database migration adding status tracking and timestamp fields to support quick capture workflow.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/03-workflow-improvements/03-RESEARCH.md
@shared/schema.ts

## Key Research Findings
- Same table with `status` field recommended over separate table
- `isCompleted` boolean already exists; extend to full status enum
- Capture/completion timestamps track workflow progress separately
- Quick notes limited to 200 chars per requirements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update inspections schema with status fields</name>
  <files>shared/schema.ts</files>
  <action>
    Extend the inspections table in shared/schema.ts with the following fields:
    1. `status` field: text type with default 'completed' for backward compatibility with existing data
       - Enum values: 'pending_review', 'completed', 'discarded'
    2. `captureTimestamp` field: timestamp type, nullable (set when quick capture created)
    3. `completionTimestamp` field: timestamp type, nullable (set when full inspection completed)
    4. `quickNotes` field: text type, max 200 chars, nullable (optional quick context)
    5. `captureLocation` field: text type, nullable (quick-select location identifier)

    Update insertInspectionSchema to make these fields optional with defaults:
    - status: default 'completed' (existing inspections are complete)
    - captureTimestamp: optional
    - completionTimestamp: optional
    - quickNotes: optional, maxLength validation
    - captureLocation: optional

    Note: Using 'completed' as default ensures existing inspections remain valid without migration of existing records.
  </action>
  <verify>npm run check passes TypeScript validation on shared/schema.ts</verify>
  <done>Schema extends inspections table with status enum, capture/completion timestamps, quickNotes, and captureLocation fields with proper Zod validation</done>
</task>

<task type="auto">
  <name>Task 2: Create and run database migration</name>
  <files>server/db/migrations/</files>
  <action>
    Create a Drizzle migration to add the new columns to the inspections table:
    1. Run `npx drizzle-kit generate` to create migration file
    2. Review generated migration includes:
       - ADD COLUMN status TEXT DEFAULT 'completed'
       - ADD COLUMN capture_timestamp TIMESTAMP
       - ADD COLUMN completion_timestamp TIMESTAMP
       - ADD COLUMN quick_notes TEXT
       - ADD COLUMN capture_location TEXT
    3. Run `npx drizzle-kit push` to apply migration to database
    4. Verify migration completes without errors

    If using Drizzle ORM push pattern directly without generate:
    - Ensure db/index.ts or equivalent applies schema changes
    - Run the appropriate push command for the project's Drizzle setup
  </action>
  <verify>Migration applies successfully; inspect database to verify new columns exist with correct types and defaults</verify>
  <done>Database migration applied; inspections table has status, capture_timestamp, completion_timestamp, quick_notes, capture_location columns</done>
</task>

<task type="auto">
  <name>Task 3: Add database indexes for performance</name>
  <files>shared/schema.ts</files>
  <action>
    Add database indexes to support pending review queries:
    1. Index on `status` field for filtering pending inspections
    2. Composite index on (status, school) for school-scoped pending lists
    3. Index on `captureTimestamp` for chronological ordering

    Add to inspections table definition:
    ```typescript
    (table) => ({
      // ... existing indexes ...
      statusIdx: index("inspections_status_idx").on(table.status),
      statusSchoolIdx: index("inspections_status_school_idx").on(table.status, table.school),
      captureTimestampIdx: index("inspections_capture_timestamp_idx").on(table.captureTimestamp),
    })
    ```

    Regenerate and apply migration if using drizzle-kit generate pattern.
  </action>
  <verify>Indexes exist in database schema; EXPLAIN query shows index usage for pending review queries</verify>
  <done>Database indexes created for status, status+school, and captureTimestamp fields</done>
</task>

</tasks>

<verification>
- [ ] TypeScript check passes with new schema
- [ ] Database migration applied successfully
- [ ] New columns exist with correct types and defaults
- [ ] Indexes created for performance
- [ ] Existing inspection data remains accessible
</verification>

<success_criteria>
- Inspections table has status column with enum values: pending_review, completed, discarded
- captureTimestamp and completionTimestamp fields support separate workflow tracking
- quickNotes field available for 200-char optional notes
- captureLocation field stores quick-select location identifier
- Database indexes enable <2s query performance for pending review lists
- Backward compatibility: existing inspections default to 'completed' status
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-improvements/03-01-SUMMARY.md`
</output>
