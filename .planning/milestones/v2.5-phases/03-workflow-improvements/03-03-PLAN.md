---
phase: 03-workflow-improvements
plan: 03
type: execute
wave: 2
depends_on:
  - 03-01
files_modified:
  - server/services/thumbnail.ts
  - server/routes.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - Server generates thumbnails for uploaded inspection photos
    - Thumbnails are 200x200 pixels with 70% JPEG quality
    - Thumbnails stored alongside original photos
    - Thumbnail generation completes in <500ms per image
  artifacts:
    - path: server/services/thumbnail.ts
      provides: generateThumbnail function using sharp library
      exports: ["generateThumbnail", "generateThumbnailAsync"]
    - path: server/routes.ts
      provides: Photo upload endpoint with automatic thumbnail generation
    - path: package.json
      provides: sharp dependency
  key_links:
    - from: photo upload endpoint
      to: server/services/thumbnail.ts
      via: generateThumbnail() call
      pattern: sharp\(.*\)\.resize
---

<objective>
Implement server-side thumbnail generation service for inspection photos.

Purpose: Generate fast-loading 200x200px thumbnails for pending review photo lists, improving page load performance.

Output: Thumbnail generation service integrated with photo upload endpoint.
</objective>

<execution_context>
@C:/Users/veloc/.config/opencode/get-shit-done/workflows/execute-plan.md
@C:/Users/veloc/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-workflow-improvements/03-RESEARCH.md
@shared/schema.ts

## Key Research Findings
- sharp library is 4-5x faster than ImageMagick for thumbnails
- Generate thumbnails on upload (not on-demand) for better UX
- Store thumbnails in same location as original with _thumb suffix or separate field
- 200x200px with 70% quality provides good balance of size and clarity
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install sharp dependency</name>
  <files>package.json</files>
  <action>
    Install sharp library for server-side image processing:
    1. Run `npm install sharp`
    2. Verify sharp is added to dependencies in package.json
    3. Run `npm run check` to ensure TypeScript types are available
    4. If type issues occur, run `npm install --save-dev @types/sharp`

    Note: sharp requires native compilation; ensure build environment has necessary tools (build-essential on Linux, Visual Studio Build Tools on Windows).
  </action>
  <verify>npm list sharp shows installed version; package.json includes sharp in dependencies</verify>
  <done>sharp library installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create thumbnail generation service</name>
  <files>server/services/thumbnail.ts</files>
  <action>
    Create server/services/thumbnail.ts with the following functions:

    1. `generateThumbnail(imageBuffer: Buffer): Promise<Buffer>`:
       - Use sharp to resize image to 200x200 pixels
       - Use 'cover' fit mode with 'center' position
       - Output JPEG with 70% quality, progressive encoding
       - Return resized image buffer
       - Add error handling for malformed images

    2. `generateThumbnailAsync(imageBuffer: Buffer): Promise<{ thumbnail: Buffer; original: Buffer }>`:
       - Generate thumbnail
       - Return both thumbnail and original buffer
       - Useful for parallel processing

    3. `generateThumbnailFromPath(imagePath: string): Promise<Buffer>`:
       - Read image from filesystem path
       - Generate and return thumbnail buffer
       - Handle file not found errors

    Implementation pattern:
    ```typescript
    import sharp from 'sharp';
    
    export async function generateThumbnail(imageBuffer: Buffer): Promise<Buffer> {
      try {
        return await sharp(imageBuffer)
          .resize(200, 200, { fit: 'cover', position: 'center' })
          .jpeg({ quality: 70, progressive: true })
          .toBuffer();
      } catch (error) {
        logger.error('Thumbnail generation failed', { error });
        throw new Error('Failed to generate thumbnail');
      }
    }
    ```

    Add proper error handling and logging using the existing logger pattern.
  </action>
  <verify>TypeScript check passes; unit test with sample image buffer generates 200x200 JPEG</verify>
  <done>Thumbnail service created with sharp-based generation functions</done>
</task>

<task type="auto">
  <name>Task 3: Update inspection photos table and integrate thumbnail generation</name>
  <files>shared/schema.ts, server/routes.ts</files>
  <action>
    1. Verify inspectionPhotos table in shared/schema.ts already has thumbnailUrl field (check existing schema - it should have been added in Phase 2).
    
    2. Update photo upload endpoint in server/routes.ts:
       - After receiving uploaded photo, generate thumbnail using thumbnail service
       - Save original photo to storage (existing pattern)
       - Save thumbnail to storage with _thumb suffix in filename
       - Store both URLs in inspection_photos table (photoUrl and thumbnailUrl)
       
    3. Update the insertInspectionPhotoSchema to include thumbnailUrl as optional field.

    4. If updating existing photo upload flow:
       - Locate existing photo upload endpoint (likely in photo-related routes)
       - Integrate thumbnail generation after image validation
       - Ensure thumbnail generation doesn't block response (use async/await properly)

    Follow existing file upload patterns in routes.ts for consistency.
  </action>
  <verify>Upload test image via API; verify thumbnail generated and thumbnailUrl stored in database</verify>
  <done>Photo uploads automatically generate and store thumbnails</done>
</task>

</tasks>

<verification>
- [ ] sharp library installed and available
- [ ] Thumbnail service generates 200x200 JPEGs in <500ms
- [ ] Photo upload endpoint generates thumbnails automatically
- [ ] Thumbnail URLs stored in inspection_photos.thumbnailUrl
- [ ] Error handling for malformed images
- [ ] TypeScript check passes
</verification>

<success_criteria>
- Server generates 200x200px thumbnails with 70% JPEG quality
- Thumbnails stored alongside original photos with accessible URLs
- Thumbnail generation completes in <500ms per image
- Photo upload API returns both original and thumbnail URLs
- Graceful handling of corrupted or unsupported image formats
- Thumbnails used in pending review list for faster loading
</success_criteria>

<output>
After completion, create `.planning/phases/03-workflow-improvements/03-03-SUMMARY.md`
</output>
