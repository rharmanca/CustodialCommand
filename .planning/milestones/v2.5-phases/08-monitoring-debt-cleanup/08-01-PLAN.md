# Phase 08 Plan 01: Memory Investigation

**Phase:** 08-monitoring-debt-cleanup  
**Plan:** 01  
**Status:** Planned  
**Goal:** Identify root cause of sustained high memory usage (93%)

---

## Requirements Addressed

- **R1:** Memory Investigation - Identify root cause of 93% memory usage

---

## Background

From Phase 02 Plan 05, monitoring identified critical memory usage at 93% (above 85% critical threshold). This plan investigates the root cause using available tools and techniques.

---

## Tasks

### Task 1: Review Railway Metrics Dashboard
**Purpose:** Establish memory trend baseline and identify when issue started

**Steps:**
1. Log into Railway dashboard for project
2. Navigate to service metrics tab
3. Set time range to "Last 7 days"
4. Document memory usage pattern:
   - Current percentage
   - Trend (increasing, steady, spiking)
   - Any correlation with deployments
5. Screenshot or note memory graph data points

**Expected Output:**
- Memory trend documented
- Deployment correlation noted
- Baseline established

**Success Criteria:**
- [ ] Railway metrics reviewed
- [ ] Trend pattern identified
- [ ] Deployment correlation checked

---

### Task 2: Check Current Health Endpoint Data
**Purpose:** Get real-time memory data from application

**Steps:**
1. Visit `https://cacustodialcommand.up.railway.app/health`
2. Record: memory usage percentage, uptime, version
3. Visit `https://cacustodialcommand.up.railway.app/health/history`
4. Review historical memory data points
5. Visit `https://cacustodialcommand.up.railway.app/health/metrics`
6. Note any active alerts

**Expected Output:**
- Current memory percentage documented
- Historical data points recorded
- Any alerts identified

**Success Criteria:**
- [ ] Health endpoint data captured
- [ ] Current memory % recorded
- [ ] Historical trends from app-level data noted

---

### Task 3: Review Application Logs for Memory Patterns
**Purpose:** Find log entries related to memory or performance

**Steps:**
1. Access Railway logs (Dashboard > Logs tab)
2. Search for patterns:
   - "memory"
   - "heap"
   - "slow request"
   - "warning"
   - "error"
3. Filter by last 7 days
4. Document any memory-related log entries
5. Note frequency and context of warnings

**Expected Output:**
- Log patterns documented
- Memory-related entries identified
- Frequency of warnings noted

**Success Criteria:**
- [ ] Logs searched for memory patterns
- [ ] Relevant entries documented
- [ ] Frequency/context noted

---

### Task 4: Code Review for Common Memory Issues
**Purpose:** Identify potential memory leaks in codebase

**Steps:**
1. Review `server/automated-monitoring.ts` - check memory tracking logic
2. Review `server/logger.ts` - check log buffer/queue sizes
3. Review database connection handling:
   - Check for unclosed connections
   - Check connection pool size
4. Review file upload handling:
   - Check photo upload endpoint
   - Check for streaming vs buffering
5. Review event listeners:
   - Check for listeners added but not removed
   - Check for event emitter usage
6. Review any in-memory caches:
   - Check for unbounded growth
   - Check for TTL/mexpiration

**Common Patterns to Check:**
- [ ] Event listeners accumulating
- [ ] Database connections not released
- [ ] Large objects cached indefinitely
- [ ] File buffers not cleaned up
- [ ] Closure references preventing GC

**Expected Output:**
- Code review findings documented
- Potential issues identified
- Root cause hypothesis formed

**Success Criteria:**
- [ ] Automated monitoring code reviewed
- [ ] Logger reviewed
- [ ] Database connection handling checked
- [ ] File upload handling checked
- [ ] Event listeners reviewed
- [ ] Caches checked

---

### Task 5: Correlate Memory with Recent Changes
**Purpose:** Identify which deployment introduced high memory

**Steps:**
1. List recent deployments (from Railway or git log)
2. Cross-reference deployment times with memory trend
3. Check git diff for commits around memory spike
4. Look for:
   - New dependencies added
   - Large data structures introduced
   - New caching logic
   - File handling changes
   - Database query changes
5. Document findings

**Expected Output:**
- Deployment timeline mapped
- Correlation identified (if any)
- Suspect commits noted

**Success Criteria:**
- [ ] Deployment history reviewed
- [ ] Memory trend correlated
- [ ] Suspect changes identified

---

### Task 6: Document Root Cause Findings
**Purpose:** Create investigation report with findings

**Steps:**
1. Compile all data:
   - Railway metrics findings
   - Health endpoint data
   - Log patterns
   - Code review results
   - Deployment correlation
2. Formulate root cause hypothesis
3. Document evidence for/against hypothesis
4. Create findings document

**Output File:** `.planning/phases/08-monitoring-debt-cleanup/08-01-FINDINGS.md`

**Success Criteria:**
- [ ] Findings document created
- [ ] Root cause hypothesis formed
- [ ] Evidence documented

---

## Verification

| Task | Verification Method | Expected Result |
|------|---------------------|-----------------|
| Task 1 | Railway dashboard screenshots | Memory trend documented |
| Task 2 | Health endpoint JSON output | Current values recorded |
| Task 3 | Log excerpts | Patterns identified |
| Task 4 | Code review notes | Potential issues flagged |
| Task 5 | Deployment correlation table | Suspect changes identified |
| Task 6 | 08-01-FINDINGS.md exists | Complete investigation report |

---

## Success Criteria (Plan Level)

- [ ] Memory trend established with data
- [ ] Root cause hypothesis formed with evidence
- [ ] Potential remediation steps identified
- [ ] Findings documented in 08-01-FINDINGS.md

---

## Related Files

- `docs/monitoring/monitoring-runbook.md` - Reference for investigation
- `docs/monitoring/performance-monitoring-guide.md` - Threshold definitions
- `server/automated-monitoring.ts` - Monitoring logic
- `server/logger.ts` - Logging infrastructure

---

## Estimated Effort

- **Duration:** 60-90 minutes
- **Complexity:** Medium
- **Blocking:** None

---

## Notes

- No new tools required - use existing monitoring infrastructure
- Railway dashboard has 7-day retention (sufficient for trend)
- Focus on investigation, not remediation (remediation is separate decision)
- Document everything for future reference

---

**Created:** 2026-02-19  
**Source:** Phase 02 Monitoring Debt  
**Next Plan:** 08-02-PLAN.md (Runbook Update)
